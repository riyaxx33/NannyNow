<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
      crossorigin="anonymous"
    />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
/* Base styles and typography */
body {
  font-family: 'Poppins', sans-serif;
  background-color: #f8f9fa;
  color: #1a1a1a;
}

/* Container width */
.container {
  max-width: 1200px;
  padding: 0.5rem;
  margin: 0 auto;
}

/* Form title */
h1 {
  font-family: 'Poppins', sans-serif;
  font-weight: 600;
  color: #000000;
  font-size: 2.5rem;
  text-align: center;
  margin-bottom: 3rem;
}

/* Card styles */
.card {
  border: 1px solid rgba(108, 92, 231, 0.2);
  background-color: white;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border-radius: 1rem;
  overflow: hidden;
  margin-bottom: 2rem;
}

/* Card header styles - Made more visible */
.card-header {
  background-color: #6c5ce7 !important; /* Override Bootstrap's bg-light */
  padding: 0.75rem 1.5rem;
  border-bottom: none;
}

.card-header h5 {
  font-weight: 600;
  font-size: 1.25rem;
  margin: 0;
  color: white !important; /* Ensure text is white */
}

/* Form controls */
.form-label {
  font-weight: 500;
  color: #000000;
  margin-bottom: 0.75rem;
  font-size: 1rem;
}

.form-control, .form-select {
  border: 1.5px solid rgba(108, 92, 231, 0.3);
  border-radius: 0.5rem;
  padding: 0.75rem 1rem;
  transition: all 0.2s;
  color: #000000;
  background-color: white;
}

.form-control:focus, .form-select:focus {
  border-color: #6c5ce7;
  box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
}

/* Child card styles */
.card.border-light {
  border: 1.5px solid rgba(108, 92, 231, 0.2);
  background-color: white;
  margin-bottom: 1rem;
}

.card.border-light .card-title {
  color: #6c5ce7;
  font-weight: 600;
}

/* Add Child button in header */
.card-header .btn-primary {
  background-color: white;
  color: #6c5ce7;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  border: 2px solid white;
}

.card-header .btn-primary:hover {
  background-color: rgba(255, 255, 255, 0.9);
}

/* Submit button */
.btn-primary {
  background-color: #6c5ce7;
  border: none;
  padding: 1rem 3rem;
  font-weight: 500;
  border-radius: 0.5rem;
  transition: all 0.2s;
}

.btn-primary:hover {
  background-color: #5b4bc4;
  transform: translateY(-1px);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .container {
    padding: 1rem;
  }
  
  .card-header {
    padding: 1rem;
  }
  
  .card-body {
    padding: 1rem;
  }
  
  h1 {
    font-size: 2rem;
    margin-bottom: 2rem;
  }
}

/* Header styles */
header {
  background-color: white;
  padding: 1rem 2rem;
  box-shadow: 0 2px 4px rgba(108, 92, 231, 0.1);
  margin-bottom: 2rem;
}

.logoo {
  height: 40px;
}

.auth-buttons .btn.login {
  background-color: #6c5ce7;
  color: white;
  padding: 0.5rem 1.5rem;
  border-radius: 0.5rem;
  transition: all 0.2s;
}

.auth-buttons .btn.login:hover {
  background-color: #5b4bc4;
}

    </style>

    <title>Parent Sign Up</title>
  </head>

  <header>
    <a href="index.html">
      <img class="logoo" src="./img/nany_logo.png" alt="Nany logo" />
    </a>
  </header>

  <body class="background">
    <div id="app" class="container">
      <form @submit.prevent="handleSubmit">
        <h1 class="mb-4">{{ isEditMode ? 'Edit Profile' : 'Parent Signup Form' }}</h1>
  
        <!-- Personal Information Section -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Personal Information</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="firstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="firstName" placeholder="First Name" v-model="firstName" required />
              </div>
              <div class="col-md-6">
                <label for="lastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="lastName" placeholder="Last Name" v-model="lastName" required />
              </div>
              <div class="col-md-6">
                <label for="dob" class="form-label">Date of Birth</label>
                <input type="date" class="form-control" id="dob" v-model="dob" required />
              </div>
              <div class="col-md-6">
                <label for="gender" class="form-label">Gender</label>
                <select class="form-select" id="gender" v-model="gender" required>
                  <option value="">Select gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Contact Information Section -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Contact Information</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" placeholder="Email Address" v-model="email" required :disabled="isEditMode" />
              </div>
              <div class="col-md-6">
                <label for="phoneNumber" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phoneNumber" placeholder="Phone Number" v-model="phoneNumber" required />
              </div>
              <div class="col-12">
                <label for="homeaddress" class="form-label">Home Address</label>
                <input type="text" class="form-control" id="homeaddress" placeholder="Home Address" v-model="homeAddress" required />
              </div>
            </div>
          </div>
        </div>
  
        <!-- Account Security Section -->
        <div class="card mb-4" v-if="!isEditMode">
          <div class="card-header">
            <h5 class="mb-0">Account Security</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" placeholder="Password" v-model="password" required @input="validatePassword" />
                <div v-if="passwordError" class="text-danger small mt-1">{{ passwordError }}</div>
              </div>
              <div class="col-md-6">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm Password" v-model="confirmPassword" required @input="validatePassword" />
                <div v-if="confirmPasswordError" class="text-danger small mt-1">{{ confirmPasswordError }}</div>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Profile Section -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Profile</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="profilePicture" class="form-label">Profile Picture</label>
                <div v-if="isEditMode && currentProfilePicture" class="mb-2">
                  <img :src="currentProfilePicture" alt="Current Profile Picture" 
                       style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;" />
                </div>
                <input type="file" class="form-control" id="profilePicture" @change="handleProfilePictureUpload" accept="image/*" />
                <small class="text-muted d-block mt-2">{{ profilePictureHelperText }}</small>
              </div>
              <div class="col-12">
                <label for="aboutMe" class="form-label">About Me</label>
                <textarea class="form-control" id="aboutMe" v-model="aboutMe" rows="4" 
                          placeholder="Write a paragraph describing yourself and your family..." required></textarea>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Children Section -->
        <div class="card mb-4">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Children</h5>
            <button type="button" class="btn btn-primary btn-sm" @click="addChild">
              <i class="fas fa-plus me-1"></i> Add Child
            </button>
          </div>
          <div class="card-body">
            <div class="row g-4">
              <div v-for="(child, index) in children" :key="index" class="col-md-6">
                <div class="card h-100 border-light">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="card-title mb-0">Child {{ index + 1 }}</h6>
                      <button type="button" class="btn btn-outline-danger btn-sm" @click="removeChild(index)">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                    <div class="mb-3">
                      <label :for="'childName' + index" class="form-label">Name</label>
                      <input type="text" class="form-control" :id="'childName' + index" placeholder="Child's Name" v-model="child.name" required />
                    </div>
                    <div class="row g-3">
                      <div class="col-6">
                        <label :for="'childAge' + index" class="form-label">Age</label>
                        <input type="number" class="form-control" :id="'childAge' + index" placeholder="Child's Age" v-model="child.age" required />
                      </div>
                      <div class="col-6">
                        <label :for="'childGender' + index" class="form-label">Gender</label>
                        <select class="form-select" :id="'childGender' + index" v-model="child.gender" required>
                          <option value="">Select</option>
                          <option value="male">Male</option>
                          <option value="female">Female</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Submit Button -->
        <div class="text-center mb-4">
          <button type="submit" class="btn btn-primary btn-lg px-5">
            {{ isEditMode ? 'Update Profile' : 'Create Account' }}
          </button>
        </div>
  
        <p v-if="errorMessage" class="error text-danger text-center">{{ errorMessage }}</p>
      </form>
    </div>
  </body>

    <script type="module">
      import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
      import {
        storeParentData,
        handleFileUpload,
        redirectToParentHome,
      } from "./backend/firebase-op.js";
      import { auth } from "./backend/firebase-config.js";
      import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

      const app = createApp({
        data() {
          return {
            email: "",
            firstName: "",
            lastName: "",
            dob: "",
            gender: "",
            homeAddress: "",
            phoneNumber: "",
            children: [{ name: "", gender: "", age: null }],
            password: "",
            confirmPassword: "",
            passwordError: "",
            confirmPasswordError: "",
            currentprofilePicture: null,
            existingProfilePictureUrl: null,
            aboutMe: "",
            errorMessage: "",
            isEditMode: false,
          };
        },
        computed: {
          profilePictureHelperText() {
            return this.isEditMode
              ? "Upload a new picture to change your current profile picture"
              : "Only image files of sizes smaller than 5MB are accepted";
          },
          isFormValid() {
            const commonValidation =
              this.firstName &&
              this.lastName &&
              this.dob &&
              this.homeAddress &&
              this.phoneNumber &&
              this.aboutMe;

            if (this.isEditMode) {
              // Don't check password fields in edit mode
              return commonValidation;
            } else {
              // Check everything including passwords for new signups
              return (
                commonValidation &&
                this.email &&
                this.password &&
                this.confirmPassword &&
                !this.passwordError &&
                !this.confirmPasswordError
              );
            }
          },
        },
        created() {
          // Check if we're in edit mode
          const urlParams = new URLSearchParams(window.location.search);
          this.isEditMode = urlParams.get("mode") === "edit";

          if (this.isEditMode) {
            this.loadExistingData();
          }
        },
        methods: {
          removeChild(index) {
    this.children.splice(index, 1);
  },
          addChild() {
            this.children.push({ name: "", gender: "", age: null });
          },

          validatePassword() {
            // Password must be at least 8 characters long and contain a number
            const passwordRegex = /^(?=.*\d).{8,}$/;

            if (!passwordRegex.test(this.password)) {
              this.passwordError =
                "Password must be at least 8 characters long and contain a number";
            } else {
              this.passwordError = "";
            }

            if (this.password !== this.confirmPassword) {
              this.confirmPasswordError = "Passwords do not match";
            } else {
              this.confirmPasswordError = "";
            }
          },

          handleProfilePictureUpload(event) {
            const file = handleFileUpload(event);
            if (file) {
              console.log("Profile picture selected:", file.name);
              this.profilePicture = file;
            } else {
              console.log("No valid file selected");
              this.profilePicture = null;
            }
          },
          async loadExistingData() {
            const storedData = sessionStorage.getItem("editProfileData");
            if (storedData) {
              const data = JSON.parse(storedData);

              // Pre-fill the form with existing data
              this.email = data.email;
              this.firstName = data.firstName;
              this.lastName = data.lastName;
              this.dob = data.dob;
              this.gender = data.gender;
              this.homeAddress = data.homeAddress;
              this.phoneNumber = data.phoneNumber;
              this.aboutMe = data.aboutMe;

              // Handle profile picture
              if (data.profilePicture) {
                this.currentProfilePicture = data.profilePicture;
                this.existingProfilePictureUrl = data.profilePictureUrl;
              }

              // Handle children data
              if (data.children && data.children.length > 0) {
                this.children = data.children;
              }

              // Clear session storage after loading
              sessionStorage.removeItem("editProfileData");
            }
          },

          async handleSubmit() {
            if (!this.isFormValid) {
              console.log("Form is not valid");
              this.errorMessage = "Please fill in all required fields.";
              return;
            }

            try {
              if (this.isEditMode) {
                // Update existing user data
                const user = auth.currentUser;
                if (!user) {
                  throw new Error("No authenticated user found");
                }

                // Create the update data object
                const updateData = {
                  email: this.email,
                  firstName: this.firstName,
                  lastName: this.lastName,
                  dob: this.dob,
                  gender: this.gender,
                  homeAddress: this.homeAddress,
                  phoneNumber: this.phoneNumber,
                  children: this.children,
                  aboutMe: this.aboutMe,
                  isEditMode: true,
                };

                // Only include profile picture if a new one was uploaded
                if (this.profilePicture) {
                  updateData.profilePicture = this.profilePicture;
                } else {
                  // Keep the existing profile picture URL
                  updateData.profilePictureUrl = this.existingProfilePictureUrl;
                }

                await storeParentData(user, updateData);
                console.log("Profile updated successfully");
                window.location.href = "parent_profilePage.html";
              } else {
                const userCredential = await createUserWithEmailAndPassword(
                  auth,
                  this.email,
                  this.password
                );
                const user = userCredential.user;

                await storeParentData(user, {
                  email: this.email,
                  firstName: this.firstName,
                  lastName: this.lastName,
                  dob: this.dob,
                  gender: this.gender,
                  homeAddress: this.homeAddress,
                  phoneNumber: this.phoneNumber,
                  children: this.children,
                  profilePicture: this.profilePicture,
                  aboutMe: this.aboutMe,
                  isEditMode: false,
                });

                console.log("User registered successfully");
                redirectToParentHome();
              }
            } catch (error) {
              console.log("Error:", error);
              this.errorMessage = error.message;
            }
          },
        },
      });

      app.mount("#app");
    </script>

    <!-- Bundled Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
