<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nanny Home - Parent Posts</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
      }

      #jobSearch::placeholder {
        font-family: "Poppins", sans-serif;
      }

      #jobDescriptionContainer {
        height: calc(100% - 70px);
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ddd;
        margin-top: 15px;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .job-card {
        background: white;
        padding: 20px;
        margin-bottom: 15px;
        width: 100%;
        cursor: pointer;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
        height: auto;
      }

      .job-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .job-card img {
        width: 80px;
        height: 80px;
        margin-right: 15px;
        border-radius: 50%;
        object-fit: cover;
      }

      .job-card-content img {
        position: relative;
        top: -25px;
      }

      .job-card-content {
        display: flex;
        align-items: center;
        width: 100%;
        font-family: "Poppins", sans-serif;
      }

      .job-card-content p {
        font-size: 15px;
      }

      .job-description {
        flex-grow: 1;
      }

      .search-container {
        position: relative;
        padding: 0;
        margin: 0;
        z-index: 1020; /* Below navbar but above other content */
        background-color: rgba(255, 255, 255, 0.9);
        width: 100%;
        background-color: white;
        border-bottom: 1px solid #eee;
      }

      .search-bar {
        display: flex;
        gap: 10px;
        align-items: center;
        font-family: "Poppins", sans-serif;
        flex-wrap: wrap;
      }

      .search-input-group {
        flex-grow: 1;
        position: relative;
      }

      .filter-dropdown {
        position: relative;
        min-width: 200px;
        font-family: "Poppins", sans-serif;
      }

      .filter-button {
        width: 100%;
        height: 45px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #495057;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .filter-button:hover {
        border-color: #adb5bd;
        background-color: #f8f9fa;
      }

      .filter-menu {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        right: 0;
        background-color: white;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        border: 1px solid #dee2e6;
        display: none;
      }

      .filter-menu.show {
        display: block;
      }

      .filter-option {
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .filter-option:hover {
        background-color: #f8f9fa;
      }

      .filter-option.active {
        background-color: #e9ecef;
        color: #007bff;
      }

      .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .active-filter {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        background-color: #e7f3ff;
        color: #007bff;
        border-radius: 20px;
        font-size: 0.9em;
      }

      .active-filter button {
        background: none;
        border: none;
        color: #007bff;
        margin-left: 8px;
        padding: 0;
        cursor: pointer;
        font-size: 14px;
      }

      #jobSearch {
          height: 45px;
          border-radius: 6px;
          padding: 0 15px;
          border: 1px solid var(--card-border);
          width: 100%;
      }

      #jobSearch:focus {
          outline: none;
          border-color: var(--linkedin-blue);
          box-shadow: 0 0 0 1px var(--linkedin-blue);
      }

      /* Updated compact styles for parent info and children sections */
      .parent-info {
        margin-bottom: 8px;
      }

      .parent-info h5 {
        font-size: 1rem;
        margin-bottom: 6px;
      }

      .parent-info p {
        font-size: 0.9rem;
        margin-bottom: 8px;
        line-height: 1.4;
      }

      /* Job Description styles to match other sections */
      #jobDescription h5 {
        font-size: 1rem;
        margin-bottom: 6px;
      }

      #jobDescription p {
        font-size: 0.9rem;
        margin-bottom: 8px;
        line-height: 1.4;
      }

      #jobDescription h5:not(:first-child) {
        margin-top: 12px;
      }

      #jobDescription p:last-child {
        margin-bottom: 12px;
      }

      .children-section {
        margin: 12px 0;
      }

      .children-title {
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 8px;
        color: #212529;
      }

      .children-container {
        display: flex;
        gap: 8px;
        justify-content: flex-start;
      }

      .child-card {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 8px 12px;
        flex: 1;
        min-width: 0;
      }

      .child-name {
        font-size: 0.9rem;
        font-weight: 500;
        color: #212529;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .child-age {
        color: #6c757d;
        font-size: 0.8rem;
      }

      .profile-header {
        display: flex;
        align-items: flex-start;
        margin-bottom: 30px;
        padding: 20px 0;
        width: 100%;
        gap: 20px;
      }

      .profile-header img {
          width: 80px;
          height: 80px;
          border-radius: 50%;
          object-fit: cover;
          transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .profile-header a {
          text-decoration: none;
          cursor: pointer;
      }

      .profile-header a:hover img {
          transform: scale(1.05);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .profile-info-wrapper {
          display: flex;
          justify-content: space-between;
          flex-grow: 1;
      }

      .profile-info {
        display: flex;
        flex-direction: column;
      }

      .profile-info h4 {
        font-size: 2.2rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
      }

      .profile-subtext {
        color: #666;
        font-size: 1.1rem;
        margin-top: 2px;
      }

      .chat-button:hover {
        background-color: #e0e0e0;
      }

      .chat-button:disabled {
        background-color: #f0f0f0;
        color: #999;
        cursor: not-allowed;
      }

      #detailsContainer {
        position: sticky;
        top: 100px;
        background: white;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 20px;
        height: calc(100vh - 120px);
        overflow-y: auto;
        font-family: "Poppins", sans-serif;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .info-and-chat-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 20px;
      }

      .parent-info {
        flex: 1;
        margin-bottom: 0; /* Override existing margin */
      }

      .chat-button-container {
        flex-shrink: 0;
        margin: 0; /* Override existing margin */
      }

      .chat-button {
        white-space: nowrap;
      }
      .chat-button-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .chat-button {
        width: 100%;
        padding: 8px 16px;
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        color: #4b5563;
        font-size: 14px;
      }

      .profile-info-wrapper {
        display: flex;
        justify-content: space-between;
        flex-grow: 1;
      }

      /* Content row */
      .row {
        display: flex;
        margin-right: -15px;
        margin-left: -15px;
      }

      /* Job cards container */
      .list-group {
        height: calc(100vh - 200px);
        overflow-y: auto;
        padding-right: 10px;
      }

      /* Main container styles */
      .container {
        width: 100%;
        padding-right: 15px;
        padding-left: 15px;
        margin-right: auto;
        margin-left: auto;
      }

      /* Column styles */
      .col-md-6 {
        position: relative;
        width: 50%;
        padding-right: 15px;
        padding-left: 15px;
      }

      @media (max-width: 768px) {
        .col-md-6 {
          width: 100%;
        }

        #detailsContainer {
          margin-top: 20px;
          height: auto;
          position: static;
        }

        .list-group {
          height: auto;
          max-height: 500px;
          scrollbar-width: none; /* Firefox */
          -ms-overflow-style: none; /* IE and Edge */
        }
      }

      .list-group::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      #detailsContainer::-webkit-scrollbar {
        display: none;
      }

      #jobDescriptionContainer::-webkit-scrollbar {
        display: none;
      }


    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyWvgXsZY9SAUG2voyScZejgbHaKIztZA"></script>
  </head>
  <body>
    <header>
      <div id="navbar"></div>
    </header>

    <div class="container" style="margin-top: 100px; padding: 0">
      <div class="search-container">
        <div class="search-bar">
          <div class="search-input-group">
            <input
              type="text"
              id="jobSearch"
              class="form-control"
              placeholder="Search postID..."
              onkeyup="searchJobs()"
            />
          </div>

          <!-- Location filter -->
          <div class="filter-dropdown">
            <button id="locationFilter" class="filter-button">
              Location
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="filter-menu" id="locationMenu"></div>
          </div>

          <!-- Date filter -->
          <div class="filter-dropdown">
            <button id="dateFilter" class="filter-button">
              Date
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="filter-menu" id="dateMenu">
              <div class="filter-option" data-value="Today">Today</div>
              <div class="filter-option" data-value="Tomorrow">Tomorrow</div>
              <div class="filter-option" data-value="This Week">This Week</div>
              <div class="filter-option" data-value="Next Week">Next Week</div>
            </div>
          </div>

          <!-- Pay Negotiable? filter -->
          <div class="filter-dropdown">
            <button id="payNegotiableFilter" class="filter-button">
              Pay Negotiable
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="filter-menu" id="payNegotiableMenu">
              <div class="filter-option" data-value="Yes">Yes</div>
              <div class="filter-option" data-value="No">No</div>
            </div>
          </div>

          <!-- Pay Range filter -->
          <div class="filter-dropdown">
            <button id="payFilter" class="filter-button">
              Pay Range
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="filter-menu" id="payMenu">
              <div class="filter-option" data-value="$0-15/hr">$0-15/hr</div>
              <div class="filter-option" data-value="$15-25/hr">$15-25/hr</div>
              <div class="filter-option" data-value="$25-35/hr">$25-35/hr</div>
              <div class="filter-option" data-value="$35+/hr">$35+/hr</div>
            </div>
          </div>
        </div>
        <div class="active-filters" id="activeFilters"></div>
      </div>
    </div>

    <div class="container mt-4" style="padding: 0">
      <div class="row">
        <!-- Job Cards Section -->
        <div class="col-md-6">
          <div class="list-group">
            <!-- Job cards will be dynamically inserted here -->
          </div>
        </div>

        <!-- Job Details Section -->
        <div class="col-md-6" id="detailsContainer">
          <div class="profile-header">
              <a href="#" style="text-decoration: none;">
                  <img id="profilePicture" src="/api/placeholder/80/80" alt="Profile Picture" />
              </a>
              <div class="profile-info-wrapper">
                  <div class="profile-info">
                      <h4 id="nannyName">Select a post to view details</h4>
                      <span id="profileSubtext" class="profile-subtext"></span>
                  </div>
                  <div class="chat-button-container">
                      <button id="chatButton" class="chat-button" disabled>
                          Chat Now
                      </button>
                      <button id="requestButton" class="chat-button" disabled>
                          Send Request
                      </button>
                  </div>
              </div>
          </div>

          <div class="parent-info" id="jobDetails">
              <!-- Parent details will be inserted here -->
          </div>

          <div id="jobDescriptionContainer">
              <div id="jobDescription">
                  <!-- Job description and about me will be inserted here -->
              </div>
          </div>
        </div>

    <!-- API KEY -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5BjPBxo5PwTs6N2PAT0YCUvT66CIQuxw&libraries=places"></script>

    <!-- Scripts -->
    <script type="module">
      import { auth, db } from "./backend/firebase-config.js";
      import {
        collection,
        getDocs,
        doc,
        getDoc,
        addDoc,
        serverTimestamp,
        updateDoc,
        arrayUnion,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      // Filter state
      let activeFilters = {
        Location: null,
        Date: null,
        Negotiable: null,
        Pay: null,
      };

      // Store all posts for filtering
      let allPosts = [];

      // Initialise filters
      function initializeFilters() {
        const filterButtons = document.querySelectorAll(".filter-button");
        // Only select filter options from date and pay menus
        const filterOptions = document.querySelectorAll(
          "#dateMenu .filter-option, #payNegotiableMenu .filter-option, #payMenu .filter-option"
        );

        // Handle filter button clicks
        filterButtons.forEach((button) => {
          button.addEventListener("click", (e) => {
            const menu = e.currentTarget.nextElementSibling;
            const isShown = menu.classList.contains("show");

            // Hide all menus first
            document.querySelectorAll(".filter-menu").forEach((m) => {
              m.classList.remove("show");
            });

            // Toggle current menu
            if (!isShown) {
              menu.classList.add("show");
            }
          });
        });

        // Handle filter option selection
        // Replace your existing filter option click handlers with this:
        filterOptions.forEach((option) => {
          option.addEventListener("click", (e) => {
            const value = e.target.dataset.value;
            const filterMenu = e.target.closest(".filter-menu");
            const buttonId = filterMenu.previousElementSibling.id;

            // Map the button ID to the correct filter key
            let filterKey;
            switch (buttonId) {
              case "dateFilter":
                filterKey = "Date";
                break;
              case "payFilter":
                filterKey = "Pay";
                break;
              case "payNegotiableFilter":
                filterKey = "Negotiable";
                break;
              case "locationFilter":
                filterKey = "Location";
                break;
              default:
                console.error("Unknown filter type:", buttonId);
                return;
            }

            console.log("Setting filter:", {
              buttonId,
              filterKey,
              value,
            });

            activeFilters[filterKey] = value;

            console.log("Active filters after update:", activeFilters);

            updateActiveFiltersUI();
            applyFilters();
            filterMenu.classList.remove("show");
          });
        });

        // Close menus when clicking outside
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".filter-dropdown")) {
            document.querySelectorAll(".filter-menu").forEach((menu) => {
              menu.classList.remove("show");
            });
          }
        });

        // Initialize search functionality
        document.getElementById("jobSearch").addEventListener("input", (e) => {
          applyFilters();
        });
      }

      // Update active filters UI
      function updateActiveFiltersUI() {
        const container = document.getElementById("activeFilters");
        container.innerHTML = "";

        Object.entries(activeFilters).forEach(([type, value]) => {
          if (value) {
            const filter = document.createElement("div");
            filter.className = "active-filter";
            filter.innerHTML = `
              ${type}: ${value}
              <button onclick="removeFilter('${type}')">×</button>
            `;
            container.appendChild(filter);
          }
        });
      }

      // Remove filter
      window.removeFilter = function (type) {
        activeFilters[type] = null;
        updateActiveFiltersUI();
        applyFilters();
      };

      // Apply filters to posts
      function applyFilters() {
        console.log(
          "Starting filter application with active filters:",
          activeFilters
        );

        const searchQuery = document
          .getElementById("jobSearch")
          .value.toLowerCase();

        const filteredPosts = allPosts.filter((post) => {
          console.log("Checking post:", {
            postId: post.postDoc.id,
            postDate: post.postData.date,
            postPay: post.postData.pay,
          });

          const matchFilters = {
            search:
              searchQuery === "" ||
              post.postDoc.id.toLowerCase().includes(searchQuery),

            location:
              !activeFilters.Location ||
              post.geocodedLocation === activeFilters.Location,

            date:
              !activeFilters.Date ||
              checkDateMatch(post.postData.date, activeFilters.Date),

            negotiable:
              !activeFilters.Negotiable ||
              checkPayNegotiableMatch(
                post.postData.payNegotiation,
                activeFilters.Negotiable
              ),

            pay:
              !activeFilters.Pay ||
              checkPayMatch(post.postData.pay, activeFilters.Pay),
          };

          console.log("Filter results for post:", {
            postId: post.postDoc.id,
            matches: matchFilters,
          });

          return Object.values(matchFilters).every((match) => match);
        });

        console.log("Filtered posts:", filteredPosts.length);
        displayFilteredPosts(filteredPosts);
      }

      // Helper function to check date matches
      function checkDateMatch(postDateString, filterValue) {
        console.log("Checking date match:", {
          postDateString,
          filterValue,
          postDate: new Date(postDateString),
          today: new Date(),
        });

        const postDate = new Date(postDateString);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        console.log("Date comparison:", {
          postDate: postDate.toISOString(),
          today: today.toISOString(),
          tomorrow: tomorrow.toISOString(),
        });

        switch (filterValue) {
          case "Today":
            const isToday = isSameDay(postDate, today);
            console.log("Is today?", isToday);
            return isToday;

          case "Tomorrow":
            const isTomorrow = isSameDay(postDate, tomorrow);
            console.log("Is tomorrow?", isTomorrow);
            return isTomorrow;

          case "This Week": {
            const weekEnd = new Date(today);
            weekEnd.setDate(today.getDate() + (6 - today.getDay()));
            weekEnd.setHours(23, 59, 59, 999);
            const isThisWeek = postDate >= today && postDate <= weekEnd;
            console.log("Is this week?", {
              isThisWeek,
              weekEnd: weekEnd.toISOString(),
            });
            return isThisWeek;
          }

          case "Next Week": {
            const nextWeekStart = new Date(today);
            nextWeekStart.setDate(today.getDate() + (7 - today.getDay()));
            const nextWeekEnd = new Date(nextWeekStart);
            nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
            nextWeekEnd.setHours(23, 59, 59, 999);
            const isNextWeek =
              postDate >= nextWeekStart && postDate <= nextWeekEnd;
            console.log("Is next week?", {
              isNextWeek,
              nextWeekStart: nextWeekStart.toISOString(),
              nextWeekEnd: nextWeekEnd.toISOString(),
            });
            return isNextWeek;
          }

          default:
            return true;
        }
      }

      function checkPayNegotiableMatch(postPayNegotiation, filterValue) {
        console.log("Checking pay negotiable:", {
          postPayNegotiation,
          filterValue,
        });
        // Convert filterValue from "Yes"/"No" to boolean
        return postPayNegotiation === (filterValue === "Yes");
      }

      // Helper function to check pay range matches
      function checkPayMatch(postPay, filterValue) {
        console.log("Checking pay match:", {
          postPay,
          filterValue,
          type: typeof postPay,
        });

        // Remove "$" and "/hr" from the filter value
        const range = filterValue.replace(/[\$\/hr]/g, "");

        if (range.includes("+")) {
          // Handle "$35+" case
          const minValue = parseInt(range);
          console.log("Plus range:", {
            minValue,
            isMatch: postPay >= minValue,
          });
          return postPay >= minValue;
        } else {
          // Handle range case (e.g., "15-25")
          const [min, max] = range.split("-").map(Number);
          console.log("Normal range:", {
            min,
            max,
            isMatch: postPay >= min && postPay <= max,
          });
          return postPay >= min && postPay <= max;
        }
      }

      // Helper date functions
      function isSameDay(d1, d2) {
        return (
          d1.getFullYear() === d2.getFullYear() &&
          d1.getMonth() === d2.getMonth() &&
          d1.getDate() === d2.getDate()
        );
      }

      function isThisWeek(date) {
        const today = new Date();
        const weekEnd = new Date(today);
        weekEnd.setDate(today.getDate() + (6 - today.getDay()));
        return date >= today && date <= weekEnd;
      }

      function isNextWeek(date) {
        const today = new Date();
        const nextWeekStart = new Date(today);
        nextWeekStart.setDate(today.getDate() + (7 - today.getDay()));
        const nextWeekEnd = new Date(nextWeekStart);
        nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
        return date >= nextWeekStart && date <= nextWeekEnd;
      }

      // Populate the location filter dropdown
      async function populateLocationFilter(allPosts) {
        try {
          const uniqueAddresses = [
            ...new Set(allPosts.map((post) => post.parentDetails.homeAddress)),
          ];
          const locationCache = new Map();

          const geocodingPromises = uniqueAddresses.map(async (address) => {
            if (!locationCache.has(address)) {
              const approxLocation = await getApproximateLocation(address);
              locationCache.set(address, approxLocation);
            }
            return locationCache.get(address);
          });

          const locations = await Promise.all(geocodingPromises);
          const uniqueLocations = [...new Set(locations)]
            .filter((location) => location !== "Location unavailable")
            .sort();

          const locationMenu = document.getElementById("locationMenu");
          locationMenu.innerHTML = ""; // Clear existing options

          uniqueLocations.forEach((location) => {
            const option = document.createElement("div");
            option.className = "filter-option";
            option.dataset.value = location;
            option.textContent = location;

            // Add click event listener directly to the option
            option.addEventListener("click", (e) => {
              activeFilters.Location = location;
              updateActiveFiltersUI();
              applyFilters();
              e.target.closest(".filter-menu").classList.remove("show");
            });

            locationMenu.appendChild(option);
          });
        } catch (error) {
          console.error("Error populating location filter:", error);
        }
      }

      // Helper function for the location filter
      async function getApproximateLocation(address) {
        return new Promise((resolve, reject) => {
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ address: address }, (results, status) => {
            if (status === "OK") {
              const approxLocation =
                results[0].address_components.find(
                  (component) =>
                    component.types.includes("neighborhood") ||
                    component.types.includes("locality")
                )?.long_name || "Location unavailable";
              resolve(approxLocation);
            } else {
              console.error(
                "Geocode was not successful for address:",
                address,
                status
              );
              resolve("Location unavailable");
            }
          });
        });
      }

      // Display filtered posts
      function displayFilteredPosts(posts) {
        const jobListContainer = document.querySelector(".list-group");
        jobListContainer.innerHTML = "";

        posts.forEach(({ postData, parentData, postDoc }) => {
          const profileImage =
            parentData.profilePictureUrl || "/api/placeholder/60/60";
          const { firstName, lastName } = parentData;

          const jobCard = document.createElement("div");
          jobCard.className = "list-group-item job-card";
          jobCard.onclick = () => showDetails(postData.userId, postDoc.id); // Ensure postDoc.id is accessible

          jobCard.innerHTML = `
      <div class="job-card-content">
        <img src="${profileImage}" alt="Profile" />
        <div class="job-description">
          <h5>${firstName} ${lastName}</h5>
          <p>
            Post ID: ${postDoc.id}<br>
            Date of Job: ${new Date(postData.date).toLocaleDateString()}<br>
            Time of Job: ${postData.startTime} - ${postData.endTime}<br>
            Expected Pay: $${postData.pay}/hr
          </p>
        </div>
      </div>
    `;

          jobListContainer.appendChild(jobCard);
        });

      }

      // Function to calculate age from DOB
      function calculateAge(dob, gender) {
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (
          monthDiff < 0 ||
          (monthDiff === 0 && today.getDate() < birthDate.getDate())
        ) {
          age--;
        }
        gender = gender.charAt(0).toUpperCase() + gender.slice(1);

        return { age, gender };
      }

      // Function to initialize chat button
      function initializeChatButton(currentUserId, parentId) {
        const chatButton = document.getElementById("chatButton");

        if (currentUserId) {
          chatButton.disabled = false;

          chatButton.addEventListener("click", async () => {
            try {
              const chatData = {
                to_user_id: parentId,
                from_user_id: auth.currentUser.uid,
                timestamp: new Date(),
                message:
                  "Hi, I'm interested in your job posting and would like to discuss details.",
              };

              await addDoc(collection(db, "CHATS"), chatData);
              alert("Message sent successfully!");
            } catch (error) {
              console.error("Error sending message:", error);
              alert("Failed to send message. Please try again.");
            }
          });
        } else {
          chatButton.disabled = true;
        }
      }

      function initializeRequestButton(currentUserId, jobId) {
        const requestButton = document.getElementById("requestButton");

        if (currentUserId) {
          // First check if user has already sent a request
          const checkExistingRequest = async () => {
            try {
              const postRef = doc(db, "POSTS", jobId);
              const postDoc = await getDoc(postRef);

              if (postDoc.exists()) {
                const postData = postDoc.data();
                // Disable button if user already sent request
                if (postData.interestedNannies.includes(currentUserId)) {
                  requestButton.disabled = true;
                  requestButton.textContent = "Request Sent";
                  return true;
                }
              }
              return false;
            } catch (error) {
              console.error("Error checking existing request:", error);
              return false;
            }
          };

          // Enable button and add click handler
          const initialize = async () => {
            const hasExistingRequest = await checkExistingRequest();
            if (!hasExistingRequest) {
              requestButton.disabled = false;

              requestButton.addEventListener("click", async () => {
                try {
                  const postRef = doc(db, "POSTS", jobId);

                  // Update the post document to add the nanny's ID to interestedNannies array
                  await updateDoc(postRef, {
                    interestedNannies: arrayUnion(currentUserId),
                  });

                  // Disable button and update text after successful request
                  requestButton.disabled = true;
                  requestButton.textContent = "Request Sent";

                  alert("Request sent successfully!");
                } catch (error) {
                  console.error("Error sending request:", error);
                  alert("Failed to send request. Please try again.");
                }
              });
            }
          };

          initialize();
        } else {
          requestButton.disabled = true;
        }
      }

      // Function to load all posts
      async function loadPosts() {
        try {
          const postsSnapshot = await getDocs(collection(db, "POSTS"));
          const jobListContainer = document.querySelector(".list-group");
          jobListContainer.innerHTML = "";

          allPosts = [];

          for (const postDoc of postsSnapshot.docs) {
            const postData = postDoc.data();

            // Skip posts where status is false or completed is true
            if (!postData.status || postData.completed) {
              continue;
            }

            const userId = postData.userId;

            // Store the post ID from Firestore
            const postId = postDoc.id; // This is the unique Firestore document ID

            const parentDoc = await getDoc(doc(db, "USER", userId));
            const parentData = parentDoc.exists() ? parentDoc.data() : null;

            const parentDetailsDoc = await getDoc(doc(db, "PARENT", userId));
            const parentDetails = parentDetailsDoc.exists()
              ? parentDetailsDoc.data()
              : null;

            if (parentData && parentData.role === "parent" && parentDetails) {
              allPosts.push({
                postDoc,
                postData,
                parentData,
                parentDetails,
                postId,
              });
            }
          }

          allPosts.sort((a, b) => {
            // Directly convert the date string to a Date object
            const dateA = new Date(a.postData.date);
            const dateB = new Date(b.postData.date);

            return dateA - dateB;
          });

          // Add geocoded locations to posts
          const geocoder = new google.maps.Geocoder();
          // Add geocoded locations to posts
          await Promise.all(
            allPosts.map(async (post) => {
              const location = await getApproximateLocation(
                post.parentDetails.homeAddress
              );
              post.geocodedLocation = location;
              console.log(
                `Post address: ${post.parentDetails.homeAddress}, Geocoded location: ${location}`
              ); // For debugging
            })
          );

          // Initialize filters after loading posts
          initializeFilters();

          // Display all posts initially
          displayFilteredPosts(allPosts);

          // Location filter dropdown
          await populateLocationFilter(allPosts);
        } catch (error) {
          console.error("Error loading posts:", error);
        }
      }

      // Function to show details when a card is clicked
      async function showDetails(userId, postId) {
    try {
        const parentDoc = await getDoc(doc(db, "USER", userId));
        const parentData = parentDoc.exists() ? parentDoc.data() : null;  // Fixed this line (was parentData.data())

        const postDoc = await getDoc(doc(db, "POSTS", postId));
        const postData = postDoc.exists() ? postDoc.data() : null;

        const parentDetailsDoc = await getDoc(doc(db, "PARENT", userId));
        const parentDetails = parentDetailsDoc.exists() ? parentDetailsDoc.data() : null;

        if (parentData && postData && parentDetails) {
        // Update profile picture and make it clickable
        const profileImg = document.getElementById("profilePicture");
        if (profileImg) {
            profileImg.src = parentData.profilePictureUrl || "/api/placeholder/80/80";
            profileImg.parentElement.href = `nanny_displayparentprofile.html?id=${userId}`;
        }

        document.getElementById(
            "nannyName"
        ).innerHTML = `${parentData.firstName} ${parentData.lastName}`;
        const { age, gender } = calculateAge(
            parentData.dob,
            parentData.gender
        );
        document.getElementById(
            "profileSubtext"
        ).innerHTML = `${gender} | ${age} years old`;

            // Update parent details
            let detailsHTML = `<h5>About:</h5>
                <p>${parentDetails.aboutMe || "No information provided"}</p>`;

            // Add children information
            if (parentDetails.children && parentDetails.children.length > 0) {
                detailsHTML += `
                    <div class="children-section">
                        <div class="children-title">Children:</div>
                        <div class="children-container">
                            ${parentDetails.children
                                .map(child => `
                                    <div class="child-card">
                                        <div class="child-name">${child.name}</div>
                                        <div class="child-age">${child.age} years old</div>
                                    </div>
                                `)
                                .join("")}
                        </div>
                    </div>
                `;
            }

            document.getElementById("jobDetails").innerHTML = detailsHTML;

            // Update description section
            let descriptionHTML = `
                <h5>Job Description:</h5>
                <p>${postData.description}</p>
            `;

            document.getElementById("jobDescription").innerHTML = descriptionHTML;

 

            // Initialize chat button
            initializeChatButton(auth.currentUser?.uid, userId);
            initializeRequestButton(auth.currentUser?.uid, postData.jobId);

            // Google Maps API
            const address = parentDetails.homeAddress;
            geocodeAddress(address);
          }
        } catch (error) {
          console.error("Error showing details:", error);
        }
      }

      // Geocoding API
      function geocodeAddress(address) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: address }, (results, status) => {
          if (status === "OK") {
            const location = results[0].geometry.location;

            const approxCityOrNeighbourhood =
              results[0].address_components.find(
                (component) =>
                  component.types.includes("neighborhood") ||
                  component.types.includes("locality")
              )?.long_name || "Location unavailable";

            document.getElementById("jobDescription").innerHTML += `
        <h5>Approximate Location:</h5>
        <p>${approxCityOrNeighbourhood}</p>
        <div id="map" style="height: 300px;"></div>
      `;

            initialiseMap(location);
          } else {
            console.error("Geocode was not successful:", status);
          }
        });
      }

      // Initialize Google Map and place a marker
      function initialiseMap(location) {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: location,
        });

        new google.maps.Marker({
          position: location,
          map: map,
        });
      }

      // Function to handle search
      window.searchJobs = function () {
        const input = document.getElementById("jobSearch");
        const filter = input.value.toLowerCase();
        const jobCards = document.querySelectorAll(".job-card");

        jobCards.forEach((card) => {
          const title = card.querySelector("h5").textContent.toLowerCase();
          const details = card
            .querySelector(".job-description")
            .textContent.toLowerCase();
          if (title.includes(filter) || details.includes(filter)) {
            card.style.display = "";
          } else {
            card.style.display = "none";
          }
        });
      };

      // Auth state listener
      auth.onAuthStateChanged((user) => {
        const chatButton = document.getElementById("chatButton");
        if (user) {
          chatButton.disabled = false;
        } else {
          chatButton.disabled = true;
        }
      });

      // Load posts when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        loadPosts();
      });

      document.addEventListener("DOMContentLoaded", function () {
        // Function to highlight active nav link
        function setActiveNavLink() {
          const currentPage =
            window.location.pathname.split("/").pop() || "nanny_home.html";
          const navLinks = document.querySelectorAll(".nav-link");

          navLinks.forEach((link) => {
            link.classList.remove("active");
            const href = link.getAttribute("href");

            if (
              href &&
              (href === currentPage ||
                (currentPage === "" && href === "nanny_home.html") ||
                (currentPage === "index.html" && href === "nanny_home.html"))
            ) {
              link.classList.add("active");
            }
          });
        }

        // Initial set
        setActiveNavLink();

        // Set on navigation
        window.addEventListener("popstate", setActiveNavLink);
      });
    </script>

    <script type="module">
      import { auth, db } from "./backend/firebase-config.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
      import {
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
      import { logout } from "./backend/auth.js";

      async function loadNavbar(user) {
        let fileToLoad = "unloggedin_navbar_template.html";

        if (user) {
          try {
            const userDoc = await getDoc(doc(db, "USER", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              if (userData.role === "parent") {
                fileToLoad = "parent_navbar_template.html";
              } else if (userData.role === "nanny") {
                fileToLoad = "nanny_navbar_template.html";
              }
            }
          } catch (error) {
            console.error("Error fetching user role:", error);
          }
        }

        try {
          const response = await fetch(fileToLoad);
          if (!response.ok) throw new Error("Network response was not ok");

          const navbarHTML = await response.text();
          document.getElementById("navbar").innerHTML = navbarHTML;

          const logoutLink = document.querySelector("#logoutBtn");
          if (logoutLink) {
            logoutLink.addEventListener("click", async (e) => {
              e.preventDefault();
              try {
                await logout();
              } catch (error) {
                console.error("Logout failed:", error);
              }
            });
          }
        } catch (error) {
          console.error("Failed to load navbar:", error);
        }
      }

      onAuthStateChanged(auth, (user) => {
        loadNavbar(user);
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
