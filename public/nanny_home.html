<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nanny Home - Parent Posts</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
#detailsContainer {
  position: sticky;
  top: 60px;
  background-color: white;
  border-left: 1px solid #ccc;
  border: 2px solid #ddd;
  border-radius: 5px;
  padding: 20px;
  height: calc(100vh - 60px);
  overflow-y: hidden;
  font-family: 'Poppins', sans-serif;
}

#jobDescriptionContainer {
  height: calc(100% - 70px);
  overflow-y: auto;
  padding: 10px;
  border: 1px solid #ddd;
  margin-top: 15px;
}

.job-card {
  cursor: pointer;
  margin-bottom: 10px;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background-color 0.3s ease;
  height: auto;
}

.job-card:hover {
  background-color: #f8f9fa;
}

.job-card img {
  width: 80px;
  height: 80px;
  margin-right: 15px;
  border-radius: 50%;
  object-fit: cover;
}

.job-card-content img {
  position: relative;
  top: -25px;
}

.job-card-content {
  display: flex;
  align-items: center;
  width: 100%;
  font-family: 'Poppins', sans-serif;
}

.job-card-content p {
  font-size: 15px;
}

.job-description {
  flex-grow: 1;
}

#jobSearch {
  width: 100%;
  border-radius: 4px;
  border: 1px solid #ccc;
  padding: 10px;
  box-shadow: none;
  margin-bottom: 20px;
}

/* Updated compact styles for parent info and children sections */
.parent-info {
  margin-bottom: 8px;
}

.parent-info h5 {
  font-size: 1rem;
  margin-bottom: 6px;
}

.parent-info p {
  font-size: 0.9rem;
  margin-bottom: 8px;
  line-height: 1.4;
}

/* Job Description styles to match other sections */
#jobDescription h5 {
  font-size: 1rem;
  margin-bottom: 6px;
}

#jobDescription p {
  font-size: 0.9rem;
  margin-bottom: 8px;
  line-height: 1.4;
}

#jobDescription h5:not(:first-child) {
  margin-top: 12px;
}

#jobDescription p:last-child {
  margin-bottom: 12px;
}

.children-section {
  margin: 12px 0;
}

.children-title {
  font-size: 1rem;
  font-weight: 500;
  margin-bottom: 8px;
  color: #212529;
}

.children-container {
  display: flex;
  gap: 8px;
  justify-content: flex-start;
}

.child-card {
  background-color: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 8px 12px;
  flex: 1;
  min-width: 0;
}

.child-name {
  font-size: 0.9rem;
  font-weight: 500;
  color: #212529;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.child-age {
  color: #6c757d;
  font-size: 0.8rem;
}

.profile-header {
  display: flex;
  align-items: flex-start;
  margin-bottom: 15px;
}

.profile-header img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  margin-right: 20px;
  object-fit: cover;
}

.profile-info {
  display: flex;
  flex-direction: column;
}

.profile-info h4 {
  font-size: 1.8rem;  /* Increased size for name */
  margin-bottom: 2px;
}

.profile-subtext {
  color: #666;
  font-size: 0.85rem;
  margin-top: 2px;
}
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyWvgXsZY9SAUG2voyScZejgbHaKIztZA"></script>
  </head>
  <body>
    <div id="navbar"></div>

    <div class="container mt-3">
      <input
        type="text"
        id="jobSearch"
        class="form-control"
        placeholder="Search posts..."
        onkeyup="searchJobs()"
      />
    </div>

    <div class="container mt-4">
      <div class="row">
        <!-- Job Cards Section -->
        <div class="col-md-6">
          <div class="list-group">
            <!-- Job cards will be dynamically inserted here -->
          </div>
        </div>

        <!-- Job Details Section -->
        <div class="col-md-6" id="detailsContainer">
          <div class="profile-header">
            <img
              id="profilePicture"
              src="/api/placeholder/80/80"
              alt="Profile Picture"
            />
            <div class="profile-info">
              <h4 id="nannyName">Select a post to view details</h4>
              <span id="profileSubtext" class="profile-subtext"></span>
            </div>
          </div>

          <div class="parent-info" id="jobDetails">
            <!-- Parent details will be inserted here -->
          </div>

          <div id="jobDescriptionContainer">
            <div id="jobDescription">
              <!-- Job description and about me will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- API KEY -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5BjPBxo5PwTs6N2PAT0YCUvT66CIQuxw&libraries=places"></script>

    <!-- Scripts -->
    <script type="module">
      import { auth, db } from "./backend/firebase-config.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
      import {
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
      import { logout } from "./backend/auth.js";

      async function loadNavbar(user) {
        let fileToLoad = "unloggedin_navbar_template.html";

        if (user) {
          try {
            const userDoc = await getDoc(doc(db, "USER", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              if (userData.role === "parent") {
                fileToLoad = "parent_navbar_template.html";
              } else if (userData.role === "nanny") {
                fileToLoad = "nanny_navbar_template.html";
              }
            }
          } catch (error) {
            console.error("Error fetching user role:", error);
          }
        }

        try {
          const response = await fetch(fileToLoad);
          if (!response.ok) throw new Error("Network response was not ok");

          const navbarHTML = await response.text();
          document.getElementById("navbar").innerHTML = navbarHTML;

          const logoutLink = document.querySelector("#logoutBtn");
          if (logoutLink) {
            logoutLink.addEventListener("click", async (e) => {
              e.preventDefault();
              try {
                await logout();
              } catch (error) {
                console.error("Logout failed:", error);
              }
            });
          }
        } catch (error) {
          console.error("Failed to load navbar:", error);
        }
      }

      onAuthStateChanged(auth, (user) => {
        loadNavbar(user);
      });
    </script>

    <!-- Firebase Integration Script -->
    <script type="module">
      import { db } from "./backend/firebase-config.js";
      import {
        collection,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      // Function to calculate age from DOB
      function calculateAge(dob) {
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (
          monthDiff < 0 ||
          (monthDiff === 0 && today.getDate() < birthDate.getDate())
        ) {
          age--;
        }
        return age;
      }

      // Function to load all posts
      async function loadPosts() {
        try {
          const postsSnapshot = await getDocs(collection(db, "POSTS"));
          const jobListContainer = document.querySelector(".list-group");
          jobListContainer.innerHTML = "";

          let firstPostUserId = null;
          let firstPostId = null;

          for (const postDoc of postsSnapshot.docs) {
            const postData = postDoc.data();
            const userId = postData.userId;

            const parentDoc = await getDoc(doc(db, "USER", userId));
            const parentData = parentDoc.exists() ? parentDoc.data() : null;

            const parentDetailsDoc = await getDoc(doc(db, "PARENT", userId));
            const parentDetails = parentDetailsDoc.exists()
              ? parentDetailsDoc.data()
              : null;

            if (parentData && parentData.role === "parent" && parentDetails) {
              const jobCard = document.createElement("div");
              jobCard.className = "list-group-item job-card";
              jobCard.onclick = () => showDetails(userId, postDoc.id);

              jobCard.innerHTML = `
                <div class="job-card-content">
                  <img src="${
                    parentData.profilePictureUrl || "/api/placeholder/60/60"
                  }" alt="Profile" />
                  <div class="job-description">
                    <h5>${parentData.firstName} ${parentData.lastName}</h5>
                    <p>Time of Job: ${postData.startTime} - ${postData.endTime}<br>
                      Expected Pay: $${postData.pay}/hr<br>
                      Date of Job: ${postData.date.toDate().toLocaleDateString()}</p>
                  </div>
                </div>
              `;

              jobListContainer.appendChild(jobCard);

              // Store the userId and postId of the first post
              if (!firstPostUserId && !firstPostId) {
                firstPostUserId = userId;
                firstPostId = postDoc.id;
              }
            }
          }

          // Show details of the first post after all posts have been loaded
          if (firstPostUserId && firstPostId) {
            showDetails(firstPostUserId, firstPostId);
          }
        } catch (error) {
          console.error("Error loading posts:", error);
        }
      }

      // Function to show details when a card is clicked
      async function showDetails(userId, postId) {
        try {
          const parentDoc = await getDoc(doc(db, "USER", userId));
          const parentData = parentDoc.exists() ? parentDoc.data() : null;

          const postDoc = await getDoc(doc(db, "POSTS", postId));
          const postData = postDoc.exists() ? postDoc.data() : null;

          const parentDetailsDoc = await getDoc(doc(db, "PARENT", userId));
          const parentDetails = parentDetailsDoc.exists()
            ? parentDetailsDoc.data()
            : null;

          if (parentData && postData && parentDetails) {
            // Update profile picture and name
            document.getElementById("profilePicture").src =
              parentData.profilePictureUrl || "/api/placeholder/80/80";
            document.getElementById(
              "nannyName"
            ).innerHTML = `${parentData.firstName} ${parentData.lastName}`;
            document.getElementById(
              "profileSubtext"
            ).innerHTML = `${parentData.gender} | ${calculateAge(parentData.dob)} years old`;

            // Update parent details
            let detailsHTML = `<h5>About:</h5>
              <p>${parentDetails.aboutMe || "No information provided"}</p>`;

// Add children information
if (parentDetails.children && parentDetails.children.length > 0) {
  detailsHTML += `
    <div class="children-section">
      <div class="children-title">Children:</div>
      <div class="children-container">
        ${parentDetails.children.map((child, index) => `
          <div class="child-card">
            <div class="child-name">${child.name}</div>
            <div class="child-age">${child.age} years old</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

            document.getElementById("jobDetails").innerHTML = detailsHTML;

            // Update description section
            let descriptionHTML = `
              <h5>Job Description:</h5>
              <p>${postData.description}</p>
                      `;

            document.getElementById("jobDescription").innerHTML =
              descriptionHTML;

            // Google Maps API
            const address = parentDetails.homeAddress;
            geocodeAddress(address);
          }
        } catch (error) {
          console.error("Error showing details:", error);
        }
      }

      // Geocoding API
      function geocodeAddress(address) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: address }, (results, status) => {
          if (status === "OK") {
            const location = results[0].geometry.location;

            // Extract approximate location (neighbourhood or city)
            const approxCityOrNeighbourhood =
              results[0].address_components.find(
                (component) =>
                  component.types.includes("neighborhood") ||
                  component.types.includes("locality")
              )?.long_name || "Location unavailable";

            document.getElementById("jobDescription").innerHTML += `
              <h5>Approximate Location:</h5>
              <p>${approxCityOrNeighbourhood}</p>
              <div id="map" style="height: 300px;"></div>
              `;

            // Initialise the map
            initialiseMap(location);
          } else {
            console.error("Geocode was not successful:", status);
          }
        });
      }

      // Initialise Google Map and place a marker
      function initialiseMap(location) {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: location,
        });

        new google.maps.Marker({
          position: location,
          map: map,
        });
      }

      // Function to handle search
      window.searchJobs = function () {
        const input = document.getElementById("jobSearch");
        const filter = input.value.toLowerCase();
        const jobCards = document.querySelectorAll(".job-card");

        jobCards.forEach((card) => {
          const title = card.querySelector("h5").textContent.toLowerCase();
          const details = card
            .querySelector(".job-description")
            .textContent.toLowerCase();
          if (title.includes(filter) || details.includes(filter)) {
            card.style.display = "";
          } else {
            card.style.display = "none";
          }
        });
      };

      // Load posts when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        loadPosts();
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>