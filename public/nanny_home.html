<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nanny Home - Parent Posts</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding-top: 60px;
      }

      #detailsContainer {
        position: sticky;
        top: 60px;
        border-left: 1px solid #ccc;
        border: 2px solid #ddd;
        border-radius: 5px;
        padding: 20px;
        height: calc(100vh - 60px);
        overflow-y: hidden;
      }

      #jobDescriptionContainer {
        height: calc(100% - 70px);
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ddd;
        margin-top: 15px;
      }

      .job-card {
        cursor: pointer;
        margin-bottom: 10px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
        height: auto;
      }

      .job-card:hover {
        background-color: #f8f9fa;
      }

      .job-card img {
        width: 60px;
        height: 60px;
        margin-right: 15px;
        border-radius: 50%;
        object-fit: cover;
      }

      .job-card-content {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .job-description {
        flex-grow: 1;
      }

      #jobSearch {
        width: 100%;
        border-radius: 4px;
        border: 1px solid #ccc;
        padding: 10px;
        box-shadow: none;
        margin-bottom: 20px;
      }

      .parent-info {
        margin-bottom: 20px;
      }

      .children-info {
        margin: 20px 0;
      }

      .description-section {
        margin-top: 20px;
      }

      .profile-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .profile-header img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-right: 20px;
        object-fit: cover;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyWvgXsZY9SAUG2voyScZejgbHaKIztZA"></script>
  </head>
  <body>
    <div id="navbar"></div>

    <div class="container mt-3">
      <input
        type="text"
        id="jobSearch"
        class="form-control"
        placeholder="Search posts..."
        onkeyup="searchJobs()"
      />
    </div>

    <div class="container mt-4">
      <div class="row">
        <!-- Job Cards Section -->
        <div class="col-md-6">
          <div class="list-group">
            <!-- Job cards will be dynamically inserted here -->
          </div>
        </div>

        <!-- Job Details Section -->
        <div class="col-md-6" id="detailsContainer">
          <div class="profile-header">
            <img
              id="profilePicture"
              src="/api/placeholder/80/80"
              alt="Profile Picture"
            />
            <h4 id="nannyName">Select a post to view details</h4>
          </div>

          <div class="parent-info" id="jobDetails">
            <!-- Parent details will be inserted here -->
          </div>

          <div id="jobDescriptionContainer">
            <div id="jobDescription">
              <!-- Job description and about me will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- API KEY -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5BjPBxo5PwTs6N2PAT0YCUvT66CIQuxw&libraries=places"></script>

    <!-- Scripts -->
    <script type="module">
      import { auth, db } from "./backend/firebase-config.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
      import {
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
      import { logout } from "./backend/auth.js";

      async function loadNavbar(user) {
        let fileToLoad = "unloggedin_navbar_template.html";

        if (user) {
          try {
            const userDoc = await getDoc(doc(db, "USER", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              if (userData.role === "parent") {
                fileToLoad = "parent_navbar_template.html";
              } else if (userData.role === "nanny") {
                fileToLoad = "nanny_navbar_template.html";
              }
            }
          } catch (error) {
            console.error("Error fetching user role:", error);
          }
        }

        try {
          const response = await fetch(fileToLoad);
          if (!response.ok) throw new Error("Network response was not ok");

          const navbarHTML = await response.text();
          document.getElementById("navbar").innerHTML = navbarHTML;

          const logoutLink = document.querySelector("#logoutBtn");
          if (logoutLink) {
            logoutLink.addEventListener("click", async (e) => {
              e.preventDefault();
              try {
                await logout();
              } catch (error) {
                console.error("Logout failed:", error);
              }
            });
          }
        } catch (error) {
          console.error("Failed to load navbar:", error);
        }
      }

      onAuthStateChanged(auth, (user) => {
        loadNavbar(user);
      });
    </script>

    <!-- Firebase Integration Script -->
    <script type="module">
      import { db } from "./backend/firebase-config.js";
      import {
        collection,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      // Function to calculate age from DOB
      function calculateAge(dob) {
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (
          monthDiff < 0 ||
          (monthDiff === 0 && today.getDate() < birthDate.getDate())
        ) {
          age--;
        }
        return age;
      }

      // Function to load all posts
      async function loadPosts() {
        try {
          const postsSnapshot = await getDocs(collection(db, "POSTS"));
          const jobListContainer = document.querySelector(".list-group");
          jobListContainer.innerHTML = "";

          for (const postDoc of postsSnapshot.docs) {
            const postData = postDoc.data();
            const userId = postData.userId;

            const parentDoc = await getDoc(doc(db, "USER", userId));
            const parentData = parentDoc.exists() ? parentDoc.data() : null;

            const parentDetailsDoc = await getDoc(doc(db, "PARENT", userId));
            const parentDetails = parentDetailsDoc.exists()
              ? parentDetailsDoc.data()
              : null;

            if (parentData && parentData.role === "parent" && parentDetails) {
              const jobCard = document.createElement("div");
              jobCard.className = "list-group-item job-card";
              jobCard.onclick = () => showDetails(userId, postDoc.id);

              jobCard.innerHTML = `
                <div class="job-card-content">
                  <img src="${
                    parentData.profilePictureUrl || "/api/placeholder/60/60"
                  }" alt="Profile" />
                  <div class="job-description">
                    <h5>${parentData.firstName} ${parentData.lastName}</h5>
                    <p>Time: ${postData.startTime} - ${postData.endTime}</p>
                    <p>Pay: $${postData.pay}/hr</p>
                    <p>Date: ${postData.date.toDate().toLocaleDateString()}</p>
                  </div>
                </div>
              `;

              jobListContainer.appendChild(jobCard);
            }
          }
        } catch (error) {
          console.error("Error loading posts:", error);
        }
      }

      // Function to show details when a card is clicked
      async function showDetails(userId, postId) {
        try {
          const parentDoc = await getDoc(doc(db, "USER", userId));
          const parentData = parentDoc.exists() ? parentDoc.data() : null;

          const postDoc = await getDoc(doc(db, "POSTS", postId));
          const postData = postDoc.exists() ? postDoc.data() : null;

          const parentDetailsDoc = await getDoc(doc(db, "PARENT", userId));
          const parentDetails = parentDetailsDoc.exists()
            ? parentDetailsDoc.data()
            : null;

          if (parentData && postData && parentDetails) {
            // Update profile picture and name
            document.getElementById("profilePicture").src =
              parentData.profilePictureUrl || "/api/placeholder/80/80";
            document.getElementById(
              "nannyName"
            ).innerHTML = `${parentData.firstName} ${parentData.lastName}`;

            // Update parent details
            let detailsHTML = `
              <p><strong>Gender:</strong> ${parentData.gender}</p>
              <p><strong>Age:</strong> ${calculateAge(parentData.dob)}</p>
            `;

            // Add children information
            if (parentDetails.children && parentDetails.children.length > 0) {
              detailsHTML += "<h5>Children:</h5>";
              parentDetails.children.forEach((child, index) => {
                const age = child.age;
                detailsHTML += `<p>Child ${index + 1}: ${
                  child.name
                }, ${age} years old</p>`;
              });
            }

            document.getElementById("jobDetails").innerHTML = detailsHTML;

            // Update description section
            let descriptionHTML = `
              <h5>Job Description:</h5>
              <p>${postData.description}</p>
              <h5>About Parent:</h5>
              <p>${parentDetails.aboutMe || "No information provided"}</p>
            `;

            document.getElementById("jobDescription").innerHTML =
              descriptionHTML;

            // Google Maps API
            const address = parentDetails.homeAddress;
            geocodeAddress(address);
          }
        } catch (error) {
          console.error("Error showing details:", error);
        }
      }

      // Geocoding API
      function geocodeAddress(address) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: address }, (results, status) => {
          if (status === "OK") {
            const location = results[0].geometry.location;

            // Extract approximate location (neighbourhood or city)
            const approxCityOrNeighbourhood =
              results[0].address_components.find(
                (component) =>
                  component.types.includes("neighborhood") ||
                  component.types.includes("locality")
              )?.long_name || "Location unavailable";

            document.getElementById("jobDescription").innerHTML += `
              <h5>Approximate Location:</h5>
              <p>${approxCityOrNeighbourhood}</p>
              <div id="map" style="height: 300px;"></div>
              `;

            // Initialise the map
            initialiseMap(location);
          } else {
            console.error("Geocode was not successful:", status);
          }
        });
      }

      // Initialise Google Map and place a marker
      function initialiseMap(location) {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: location,
        });

        new google.maps.Marker({
          position: location,
          map: map,
        });
      }

      // Function to handle search
      window.searchJobs = function () {
        const input = document.getElementById("jobSearch");
        const filter = input.value.toLowerCase();
        const jobCards = document.querySelectorAll(".job-card");

        jobCards.forEach((card) => {
          const title = card.querySelector("h5").textContent.toLowerCase();
          const details = card
            .querySelector(".job-description")
            .textContent.toLowerCase();
          if (title.includes(filter) || details.includes(filter)) {
            card.style.display = "";
          } else {
            card.style.display = "none";
          }
        });
      };

      // Load posts when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        loadPosts();
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
