<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nanny Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script type="module" src="https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js"></script>

    <style>
        :root {
          --linkedin-blue: #0a66c2;
          --linkedin-light-blue: #70b5f9;
          --linkedin-background: #f3f2ef;
          --card-border: #e0e0e0;
        }
  
        body * {
          font-family: "Poppins", sans-serif !important;
        }
  
        body {
          background-color: var(--linkedin-background);
          font-family: "Poppins", sans-serif;
          padding-top: 100px;
        }
  
        /* Profile Background */
        .profile-background {
          height: 200px;
          background-color: var(--linkedin-light-blue);
          border-radius: 8px 8px 0 0;
          position: relative;
        }
  
        /* Profile Section */
        .profile-section {
          background: white;
          border-radius: 8px;
          border: 1px solid var(--card-border);
          margin-bottom: 20px;
          padding: 24px;
        }
  
        /* Avatar */
        .avatar-container {
          position: relative;
          margin-top: -72px;
          padding-left: 24px;
        }
  
        .avatar {
          width: 152px;
          height: 152px;
          border: 4px solid white;
          border-radius: 50%;
          object-fit: cover;
        }
  
        /* Profile Info */
        .profile-info {
          padding-top: 24px;
        }
  
        .profile-name {
          font-size: 24px;
          font-weight: 600;
          color: rgba(0, 0, 0, 0.9);
          margin-bottom: 4px;
        }
  
        .profile-headline {
          font-size: 16px;
          color: rgba(0, 0, 0, 0.9);
          margin-bottom: 8px;
        }
  
        .profile-location {
          font-size: 14px;
          color: rgba(0, 0, 0, 0.6);
          margin-bottom: 4px;
        }
  
        .profile-contact {
          font-size: 14px;
          color: rgba(0, 0, 0, 0.6);
          margin-bottom: 4px;
          display: flex;
          align-items: center;
          gap: 16px;
        }
  
        /* Section Styling */
        .section-title {
          font-size: 20px;
          font-weight: 600;
          color: rgba(0, 0, 0, 0.9);
          margin-bottom: 16px;
        }
  
        /* Buttons */
        .btn-primary,
        .btn-edit {
          background-color: var(--linkedin-blue);
          border-color: var(--linkedin-blue);
          color: white;
        }
  
        .btn-outline-primary {
          color: var(--linkedin-blue);
          border-color: var(--linkedin-blue);
        }
  
        .btn-outline-primary:hover {
          background-color: rgba(112, 181, 249, 0.2);
          border-color: var(--linkedin-blue);
          color: var(--linkedin-blue);
        }
        .no-jobs-message {
  color: rgba(0, 0, 0, 0.6);
  text-align: center;
  padding: 20px;
  background-color: var(--linkedin-background);
  border-radius: 8px;
  font-size: 14px;
}

.job-card {
  background: white;
  border: 1px solid var(--card-border);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
}

.job-header {
  margin-bottom: 16px;
}

.job-title {
  font-size: 16px;
  font-weight: 600;
  color: rgba(0, 0, 0, 0.9);
}

.badge-completed {
  background-color: var(--linkedin-blue);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.job-date {
  font-size: 14px;
  color: rgba(0, 0, 0, 0.6);
  margin-top: 4px;
}

.job-details {
  border-top: 1px solid var(--card-border);
  padding-top: 16px;
}

.detail-row {
  display: flex;
  margin-bottom: 12px;
}

.detail-label {
  font-weight: 500;
  color: rgba(0, 0, 0, 0.6);
  width: 120px;
  flex-shrink: 0;
}

.detail-value {
  color: rgba(0, 0, 0, 0.9);
}

@media (max-width: 767px) {
  .detail-row {
    flex-direction: column;
  }
  
  .detail-label {
    width: 100%;
    margin-bottom: 4px;
  }
}
  
        /* Responsive Breakpoints */
        @media (min-width: 768px) {
          .profile-info {
            padding-top: 80px;
          }
  
          .w-md-auto {
            width: auto !important;
          }
        }
  
        @media (max-width: 767px) {
          .profile-background {
            height: 160px;
          }
  
          .avatar {
            width: 120px;
            height: 120px;
          }
  
          .avatar-container {
            margin-top: -60px;
          }
  
          .profile-contact {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
          }
        }
      </style>
  </head>
  <body>
    <header>
      <div id="navbar"></div>
    </header>

    <div id="app" class="container py-4">
      <div v-if="loading" class="text-center mt-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p>Loading...</p>
      </div>

      <div v-else-if="error" class="alert alert-danger mt-3">{{ error }}</div>

      <div v-else>
        <!-- Main Profile Card -->
        <div class="profile-section p-0">
          <!-- Background Cover -->
          <div class="profile-background"></div>

          <div class="container-fluid px-0">
            <div class="row">
              <div class="col-12">
                <div class="avatar-container">
                  <img :src="profileData.profilePicture" alt="Profile Picture" class="avatar" />
                </div>
              </div>
            </div>

            <!-- Profile Info -->
            <div class="profile-info px-3 px-md-4 pb-4">
              <div class="row align-items-start">
                <div class="col-md-8">
                  <h1 class="profile-name">
                    {{ profileData.firstName }} {{ profileData.lastName }}
                  </h1>
                  <p class="profile-headline">Nanny</p>
                  <p class="profile-location">üìç {{ profileData.address }}</p>
                  <div class="profile-contact">
                    <span>üìß {{ profileData.email }}</span>
                    <span>üì± {{ profileData.phoneNumber }}</span>
                  </div>
                </div>
                <div class="col-md-4 d-flex justify-content-md-end mt-3 mt-md-0">
                  <button class="btn btn-chat w-100 w-md-auto" @click="startChat">
                    Chat with Nanny
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- About Section -->
        <div class="profile-section">
          <h2 class="section-title">About Me</h2>
          <div class="row">
            <div class="col-12">
              <p>{{ profileData.aboutMe }}</p>
            </div>
          </div>
        </div>

        <!-- Personal Information Section -->
        <div class="profile-section">
          <h2 class="section-title">Personal Information</h2>
          <div class="row">
            <div class="col-md-6 col-lg-4">
              <p><strong>Date of Birth:</strong> {{ profileData.dob }}</p>
            </div>
            <div class="col-md-6 col-lg-4">
              <p><strong>Gender:</strong> {{ profileData.gender }}</p>
            </div>
          </div>
        </div>

        <!-- Experience Section -->
        <div class="profile-section">
          <h2 class="section-title">Experience</h2>
          <div class="row">
            <div class="col-12">
              <p><strong>Years of Experience:</strong> {{ profileData.yearsOfExperience }}</p>
              <p><strong>Experience Details:</strong> {{ profileData.experienceDetails }}</p>
            </div>
          </div>
        </div>

        <!-- Qualifications Section -->
        <div class="profile-section">
          <h2 class="section-title">Qualifications</h2>
          <div class="row">
            <div class="col-12">
              <p><strong>Education Level:</strong> {{ profileData.educationLevel }}</p>
              <p><strong>Certifications:</strong> {{ profileData.certifications }}</p>
            </div>
          </div>
        </div>
        <!-- Add this after your Qualifications Section -->
    <div v-if="!loading" class="profile-section">
        <h2 class="section-title">Completed Jobs</h2>
        <div class="row">
          <div class="col-12">
            <div v-if="completedJobs.length === 0" class="no-jobs-message">
              No completed jobs with this nanny yet.
            </div>
            
            <div v-else>
              <div v-for="job in completedJobs" :key="job.id" class="job-card mb-3">
                <div class="job-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="job-title mb-0">Job ID: {{ job.jobId }}</h5>
                    <span class="badge badge-completed">Completed</span>
                  </div>
                  <p class="job-date mb-2">{{ formatDate(job.date) }}</p>
                </div>
                
                <div class="job-details">
                  <div class="detail-row">
                    <span class="detail-label">Time:</span>
                    <span class="detail-value">{{ job.startTime }} - {{ job.endTime }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Pay:</span>
                    <span class="detail-value">${{ job.pay }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Pay Negotiable:</span>
                    <span class="detail-value">{{ job.payNegotiation ? 'Yes' : 'No' }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Notes:</span>
                    <span class="detail-value">{{ job.description }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      </div>
    </div>

    
      


    <script type="module">
import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
import { db, storage } from "./backend/firebase-config.js";
import { initAuth, getCurrentUser, getUserRole } from "./backend/auth.js";
import { doc, getDoc, addDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

createApp({
    data() {
        return {
            profileData: null,
            loading: true,
            error: null,
            nannyId: null,
            completedJobs: []
        };
    },

    created() {
        console.log("Created hook started");
        const urlParams = new URLSearchParams(window.location.search);
        this.nannyId = urlParams.get('id');
        console.log("Nanny ID from URL:", this.nannyId);
        
        if (!this.nannyId) {
            this.error = "No nanny ID provided";
            this.loading = false;
            return;
        }
        
        // Initialize auth listener
        initAuth(async (user) => {
            console.log("Auth state changed, user:", user?.uid);
            if (user) {
                try {
                    const role = await getUserRole(user.uid);
                    console.log("User role:", role);
                    if (role !== "parent") {
                        this.error = "Access denied. This page is for parents only.";
                        this.loading = false;
                        return;
                    }
                    await this.fetchNannyProfile(this.nannyId);
                    await this.fetchNannyCompletedJobs();
                } catch (error) {
                    console.error("Auth error:", error);
                    this.error = "Error: " + error.message;
                } finally {
                    this.loading = false;
                }
            } else {
                window.location.href = "login.html";
            }
        });
    },

    methods: {
        async fetchNannyProfile(nannyId) {
            try {
                const userDocRef = doc(db, "USER", nannyId);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    this.profileData = userDocSnap.data();

                    if (this.profileData.profilePictureUrl) {
                        this.profileData.profilePicture = await this.getProfilePictureUrl(
                            this.profileData.profilePictureUrl
                        );
                    }

                    const nannyDocRef = doc(db, "NANNY", nannyId);
                    const nannyDocSnap = await getDoc(nannyDocRef);

                    if (nannyDocSnap.exists()) {
                        this.profileData = {
                            ...this.profileData,
                            ...nannyDocSnap.data()
                        };
                    } else {
                        this.error = "No nanny data found.";
                    }
                } else {
                    this.error = "No user data found";
                }
            } catch (error) {
                this.error = "Error fetching profile data";
                console.error("Error fetching profile data:", error);
            }
        },

        async getProfilePictureUrl(filePath) {
            const storageRef = ref(storage, filePath);
            return await getDownloadURL(storageRef);
        },

        async startChat() {
            try {
                const currentUser = await getCurrentUser();
                const chatData = {
                    to_user_id: this.nannyId,
                    from_user_id: currentUser.uid,
                    timestamp: new Date(),
                    message: "Hi, I'm interested in connecting with you regarding childcare services."
                };
                
                await addDoc(collection(db, "CHATS"), chatData);
                window.location.href = `parent_chat.html?nannyId=${this.nannyId}&autoSelect=true`;
            } catch (error) {
                console.error("Error starting chat:", error);
                alert("Failed to start chat. Please try again.");
            }
        },

        async fetchNannyCompletedJobs() {
            try {
                console.log("Fetching completed jobs for nanny:", this.nannyId);
                const postsCollection = collection(db, "POSTS");
                const querySnapshot = await getDocs(postsCollection);
                
                const allPosts = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    jobId: doc.id,
                    ...doc.data()
                }));
                console.log("All posts:", allPosts);

                // Filter for completed jobs
                this.completedJobs = allPosts
                    .filter(post => {
                        const isNannyJob = post.nanny_id === this.nannyId;
                        const isCompleted = post.completed === true;
                        const isInactive = post.status === false;

                        console.log(`Post ${post.id} check:`, {
                            nanny_id: post.nanny_id,
                            expectedNannyId: this.nannyId,
                            isNannyJob,
                            completed: post.completed,
                            isCompleted,
                            status: post.status,
                            isInactive
                        });

                        return isNannyJob && isCompleted && isInactive;
                    })
                    .map(post => ({
                        ...post,
                        formattedDate: this.formatDate(post.date)
                    }))
                    .sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateB - dateA;
                    });

                console.log("Filtered completed jobs:", this.completedJobs);
            } catch (error) {
                console.error("Error fetching completed jobs:", error);
            }
        },

        formatDate(date) {
            if (date && typeof date === 'string') {
                const [year, month, day] = date.split('-');
                return `${day}/${month}/${year}`;
            }
            return "";
        }
    }
}).mount("#app");
</script>

<script type="module">
    import { auth, db } from "./backend/firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      doc,
      getDoc,
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { logout } from "./backend/auth.js";

    async function loadNavbar(user) {
      let fileToLoad = "unloggedin_navbar_template.html";

      if (user) {
        try {
          const userDoc = await getDoc(doc(db, "USER", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            if (userData.role === "parent") {
              fileToLoad = "parent_navbar_template.html";
            } else if (userData.role === "nanny") {
              fileToLoad = "nanny_navbar_template.html";
            }
          }
        } catch (error) {
          console.error("Error fetching user role:", error);
        }
      }

      try {
        const response = await fetch(fileToLoad);
        if (!response.ok) throw new Error("Network response was not ok");

        const navbarHTML = await response.text();
        document.getElementById("navbar").innerHTML = navbarHTML;

        // Add event listener to logout link after navbar is loaded
        const logoutLink = document.querySelector("#logoutBtn");
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault(); // Prevent the default link behavior
            console.log("Logout clicked");
            try {
              await logout(); // The redirect is now handled in the logout function
            } catch (error) {
              console.error("Logout failed:", error);
            }
          });
        } else {
          console.log("Logout link not found");
        }
      } catch (error) {
        console.error("Failed to load navbar:", error);
      }
    }

    onAuthStateChanged(auth, (user) => {
      console.log("Auth state changed");
      loadNavbar(user);
    });
  </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>