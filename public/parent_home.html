<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NANYNow - Nanny Listing Page</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>

      /* Make the right details container fixed */
      #detailsContainer {
        position: sticky;
        top: 60px; /* Matches the navbar height to keep it aligned */
        border-left: 1px solid #ccc;
        border: 2px solid #ddd;
        border-radius: 5px;
        padding: 20px;
        height: calc(
          100vh - 60px
        ); /* Ensures it takes full height minus the navbar */
        overflow-y: auto; /* Allow vertical scroll within the container if content exceeds */
      }

      /* Styling the container that holds the job description */
      #jobDescriptionContainer {
        height: 300px; /* Set a fixed height for the description section */
        overflow-y: auto; /* Enables vertical scrolling */
        padding: 10px;
        border: 1px solid #ddd; /* Optional: Add a border around the scrollable area */
        margin-top: 15px;
      }

      /* Job card styling */
      .job-card {
        cursor: pointer;
        margin-bottom: 10px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
      }

      .job-card:hover {
        background-color: #f8f9fa;
      }

      .job-card img {
        width: 100px;
        height: 100px;
        margin-right: 15px;
      }

      .job-card-content {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .job-description {
        flex-grow: 1;
      }

      /* Optional: Styling for filters */
      #dayFilter,
      #timeFilter,
      #salaryFilter {
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
      }

      .chat-button-container {
        text-align: center;
        margin: 20px 0;
      }

      .chat-button {
        padding: 10px 30px;
        font-size: 1.1em;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .chat-button:hover {
        background-color: #0056b3;
      }

      .chat-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="navbar"></div> <!-- Placeholder for navbar -->

      <div class="container mt-3">
        <input
          type="text"
          v-model="searchQuery"
          class="form-control"
          placeholder="Search for NANNY..."
          @input="searchJobs"
        />
      </div>

      <!-- Main Content Section -->
      <div class="container mt-5">
        <div class="row">
          <!-- Nanny Cards Section -->
          <div class="col-md-6">
            <div class="list-group">
              <div
                v-for="nanny in filteredNannies"
                :key="nanny.id"
                class="list-group-item job-card"
                @click="showDetails(nanny)"
              >
                <div class="job-card-content">
                  <img
                    :src="nanny.profilePictureURL || 'https://via.placeholder.com/60'"
                    :alt="nanny.firstName + ' ' + nanny.lastName"
                  />
                  <div class="job-description">
                    <h5>{{ nanny.firstName }} {{ nanny.lastName }}</h5>
                    <p>Experience: {{ nanny.yrsExperience || 'N/A' }} years</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Nanny Details Section -->
          <div class="col-md-6" id="detailsContainer">
            <h4>
              {{ selectedNanny ? selectedNanny.firstName + ' ' +
              selectedNanny.lastName : 'Select a nanny to view details' }}
            </h4>
            <div v-if="selectedNanny">
              <p>Email: {{ selectedNanny.email }}</p>
              <p>Gender: {{ selectedNanny.gender }}</p>
              <p>Date of Birth: {{ selectedNanny.dob }}</p>
              <p>
                Years of Experience: {{ selectedNanny.yrsExperience || 'N/A' }}
              </p>
              <div class="chat-button-container">
                <button
                  class="chat-button"
                  @click="sendMessage"
                  :disabled="!currentUserId || !selectedNanny"
                >
                  Chat Now
                </button>
              </div>
            </div>
            <div id="jobDescriptionContainer">
              <div id="jobDescription">
                {{ selectedNanny ? selectedNanny.description : '' }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        createApp,
        ref,
        computed,
        onMounted,
      } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
      import { db, auth } from "./backend/firebase-config.js"; // Make sure auth is imported
      import {
        collection,
        query,
        where,
        getDocs,
        doc,
        getDoc,
        addDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      createApp({
        setup() {
          const nannies = ref([]);
          const selectedNanny = ref(null);
          const searchQuery = ref("");
          const currentUserId = ref(null);

          const fetchNannies = async () => {
            try {
              const userCollectionRef = collection(db, "USER");
              const q = query(userCollectionRef, where("role", "==", "nanny"));
              const userSnapshot = await getDocs(q);

              const nannyData = await Promise.all(
                userSnapshot.docs.map(async (userDoc) => {
                  const userData = userDoc.data();
                  const nannyDocRef = doc(db, "NANNY", userDoc.id);
                  const nannySnapshot = await getDoc(nannyDocRef);
                  const nannyDetails = nannySnapshot.data();
                  return { ...userData, ...nannyDetails, id: userDoc.id };
                })
              );

              nannies.value = nannyData;
              console.log("Fetched nannies:", nannyData); // Add this for debugging
            } catch (error) {
              console.error("Error fetching nanny data:", error);
            }
          };

          const sendMessage = async () => {
            if (!currentUserId.value || !selectedNanny.value) {
              alert("Please log in to send messages");
              return;
            }

            try {
              const chatData = {
                to_user_id: selectedNanny.value.id,
                from_user_id: currentUserId.value,
                timestamp: serverTimestamp(),
                message: `Hi, I would like to hire you and discuss details.`,
              };

              await addDoc(collection(db, "CHATS"), chatData);
              alert("Message sent successfully!");
            } catch (error) {
              console.error("Error sending message:", error);
              alert("Failed to send message. Please try again.");
            }
          };

          const filteredNannies = computed(() => {
            const query = searchQuery.value.toLowerCase();
            return nannies.value.filter(
              (nanny) =>
                nanny.firstName?.toLowerCase().includes(query) ||
                nanny.lastName?.toLowerCase().includes(query) ||
                (nanny.yrsExperience &&
                  nanny.yrsExperience.toString().includes(query))
            );
          });

          const showDetails = (nanny) => {
            selectedNanny.value = nanny;
          };

          const searchJobs = () => {
            // The filtering is handled by the computed property
          };

          // Combine both onMounted operations into one
          onMounted(() => {
            // Set up auth state listener
            auth.onAuthStateChanged((user) => {
              currentUserId.value = user ? user.uid : null;
            });

            // Fetch nannies
            fetchNannies();
          });

          return {
            nannies,
            selectedNanny,
            searchQuery,
            filteredNannies,
            showDetails,
            searchJobs,
            sendMessage,
            currentUserId,
          };
        },
      }).mount("#app");
    </script>

<script type="module">
    import { auth, db } from "./backend/firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { logout } from './backend/auth.js';
    
    async function loadNavbar(user) {
        let fileToLoad = 'unloggedin_navbar_template.html';

        if (user) {
            try {
                const userDoc = await getDoc(doc(db, "USER", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.role === 'parent') {
                        fileToLoad = 'parent_navbar_template.html';
                    } else if (userData.role === 'nanny') {
                        fileToLoad = 'nanny_navbar_template.html';
                    }
                }
            } catch (error) {
                console.error('Error fetching user role:', error);
            }
        }

        try {
            const response = await fetch(fileToLoad);
            if (!response.ok) throw new Error('Network response was not ok');

            const navbarHTML = await response.text();
            document.getElementById('navbar').innerHTML = navbarHTML;

            // Add event listener to logout link after navbar is loaded
            const logoutLink = document.querySelector('#logoutBtn');
            if (logoutLink) {
                logoutLink.addEventListener('click', async (e) => {
                    e.preventDefault(); // Prevent the default link behavior
                    console.log("Logout clicked");
                    try {
                        await logout(); // The redirect is now handled in the logout function
                    } catch (error) {
                        console.error('Logout failed:', error);
                    }
                });
            } else {
                console.log('Logout link not found');
            }
        } catch (error) {
            console.error('Failed to load navbar:', error);
        }
    }

    onAuthStateChanged(auth, (user) => {
        console.log('Auth state changed');
        loadNavbar(user);
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
