<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NANYNow - Nanny Listing Page</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Make the right details container fixed */
      #detailsContainer {
        position: sticky;
        background-color: white;
        top: 60px; /* Matches the navbar height to keep it aligned */
        border-left: 1px solid #ccc;
        border: 2px solid #ddd;
        border-radius: 5px;
        padding: 20px;
        font-family: 'Poppins', sans-serif;
        height: calc(
          100vh - 60px
        ); /* Ensures it takes full height minus the navbar */
        overflow-y: auto; /* Allow vertical scroll within the container if content exceeds */
      }

      /* Styling the container that holds the job description */
      #jobDescriptionContainer {
        height: 300px; /* Set a fixed height for the description section */
        overflow-y: auto; /* Enables vertical scrolling */
        padding: 10px;
        border: 1px solid #ddd; /* Optional: Add a border around the scrollable area */
        margin-top: 15px;
      }

      /* Job card styling */
      .job-card {
        cursor: pointer;
        margin-bottom: 10px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
        font-family: 'Poppins', sans-serif;
      }

      .job-card:hover {
        background-color: #f8f9fa;
      }

      .job-card img {
        width: 100px;
        height: 100px;
        margin-right: 15px;
      }

      .job-card-content {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .job-description {
        flex-grow: 1;
        font-family: 'Poppins', sans-serif;
      }

      .chat-button-container {
        text-align: center;
        margin: 20px 0;
      }

      .chat-button {
        padding: 10px 30px;
        font-size: 1.1em;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-family: 'Poppins', sans-serif;
      }

      .chat-button:hover {
        background-color: #0056b3;
      }

      .chat-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .search-container {
        position: relative;
        padding: 10px;
        margin:0px;
      }

      .search-bar {
        display: flex;
        gap: 15px;
        align-items: center;
        font-family: 'Poppins', sans-serif;
        height: 30px;
      }

      .search-input-group {
        flex-grow: 1;
        position: relative;
      }

      .search-input-group i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
      }

      .search-input {
        padding-left: 40px;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        height: 45px;
      }

      .filter-dropdown {
        position: relative;
        min-width: 200px;
        font-family: 'Poppins', sans-serif;
      }

      .filter-button {
        width: 100%;
        height: 35px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #495057;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .filter-button:hover {
        border-color: #adb5bd;
        background-color: #f8f9fa;
      }

      .filter-button i {
        color: #6c757d;
      }

      .filter-menu {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        right: 0;
        margin-top: 5px;
        background-color: white;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        border: 1px solid #dee2e6;
        display: none;
      }

      .filter-menu.show {
        display: block;
      }

      .filter-option {
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .filter-option:hover {
        background-color: #f8f9fa;
      }

      .filter-option.active {
        background-color: #e9ecef;
        color: #007bff;
      }

      .filter-option:first-child {
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
      }

      .filter-option:last-child {
        border-bottom-left-radius: 6px;
        border-bottom-right-radius: 6px;
      }

      .active-filter {
        display: inline-block;
        padding: 4px 12px;
        background-color: #e7f3ff;
        color: #007bff;
        border-radius: 20px;
        font-size: 0.9em;
        margin-top: 10px;
        margin-right: 10px;
      }

      .active-filter i {
        margin-left: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="navbar"></div>
      <!-- Placeholder for navbar -->

      <div class="container mt-3">
        <div class="search-container">
          <div class="search-bar">
            <div class="search-input-group">
              <i class="fas fa-search"></i>
              <input
                type="text"
                v-model="searchQuery"
                class="form-control"
                placeholder="Search for NANNY..."
                @input="searchJobs"
              />
            </div>

            <div class="filter-dropdown" @click.stop>
              <button class="filter-button" @click="toggleFilterMenu">
                <span
                  >{{ experienceFilter ? `${experienceFilter} Experience` :
                  `Experience Level` }}</span
                >
                <i
                  class="fas"
                  :class="showFilterMenu ? 'fa-chevron-up' :
                'fa-chevron-down' "
                ></i>
              </button>

              <div class="filter-menu" :class="{ show: showFilterMenu }">
                <div
                  class="filter-option"
                  :class="{ active: experienceFilter === '' }"
                  @click="setExperienceFilter('')"
                >
                  All Experience Levels
                </div>
                <div
                  v-for="option in experienceOptions"
                  :key="option.value"
                  class="filter-option"
                  :class="{ active: experienceFilter === option.value }"
                  @click="setExperienceFilter(option.value)"
                >
                  {{ option.label }}
                </div>
              </div>
            </div>
          </div> 

          <!-- Active filters display -->
          <div v-if="experienceFilter" class="active-filter">
            {{ experienceFilter }} Experience
            <i class="fas fa-times" @click="clearExperienceFilter"></i>
          </div>
        </div>
      </div>

      <!-- Main Content Section -->
      <div class="container mt-3">
        <div class="row">
          <!-- Nanny Cards Section -->
          <div class="col-md-6">
            <div class="list-group">
              <div
                v-for="nanny in filteredNannies"
                :key="nanny.id"
                class="list-group-item job-card"
                @click="showDetails(nanny)"
              >
                <div class="job-card-content">
                  <img
                    :src="nanny.profilePictureURL || 'https://via.placeholder.com/60'"
                    :alt="nanny.firstName + ' ' + nanny.lastName"
                  />
                  <div class="job-description">
                    <h5>{{ nanny.firstName }} {{ nanny.lastName }}</h5>
                    <p>Experience: {{ nanny.yrsExperience || 'N/A' }} years</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Nanny Details Section -->
          <div class="col-md-6" id="detailsContainer">
            <h4>
              {{ selectedNanny ? selectedNanny.firstName + ' ' +
              selectedNanny.lastName : 'Select a nanny to view details' }}
            </h4>
            <div v-if="selectedNanny">
              <p>Email: {{ selectedNanny.email }}</p>
              <p>Gender: {{ selectedNanny.gender }}</p>
              <p>Date of Birth: {{ selectedNanny.dob }}</p>
              <p>
                Years of Experience: {{ selectedNanny.yrsExperience || 'N/A' }}
              </p>
              <div class="chat-button-container">
                <button
                  class="chat-button"
                  @click="sendMessage"
                  :disabled="!currentUserId || !selectedNanny"
                >
                  Chat Now
                </button>
              </div>
            </div>
            <div id="jobDescriptionContainer">
              <div id="jobDescription">
                {{ selectedNanny ? selectedNanny.description : '' }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        createApp,
        ref,
        computed,
        onMounted,
        onUnmounted,
      } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
      import { db, auth } from "./backend/firebase-config.js";
      import {
        collection,
        query,
        where,
        getDocs,
        doc,
        getDoc,
        addDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      createApp({
        setup() {
          const nannies = ref([]);
          const selectedNanny = ref(null);
          const searchQuery = ref("");
          const currentUserId = ref(null);
          const experienceFilter = ref("");
          const showFilterMenu = ref(false);

          const experienceOptions = [
            { value: "0-2", label: "0-2 years" },
            { value: "3-5", label: "3-5 years" },
            { value: "6-10", label: "6-10 years" },
            { value: "10+", label: "10+ years" },
          ];

          const toggleFilterMenu = () => {
            showFilterMenu.value = !showFilterMenu.value;
          };

          const setExperienceFilter = (value) => {
            experienceFilter.value = value;
            showFilterMenu.value = false;
          };

          const clearExperienceFilter = () => {
            experienceFilter.value = "";
          };

          const handleClickOutside = (event) => {
            const filterDropdown = document.querySelector(".filter-dropdown");
            if (filterDropdown && !filterDropdown.contains(e.target)) {
              showFilterMenu.value = false;
            }
          };

          const matchesExperienceFilter = (nanny, filter) => {
            if (!filter) return true;
            const exp = Number(nanny.yrsExperience) || 0;

            switch (filter) {
              case "0-2":
                return exp >= 0 && exp <= 2;
              case "3-5":
                return exp >= 3 && exp <= 5;
              case "6-10":
                return exp >= 6 && exp <= 10;
              case "10+":
                return exp >= 10;
              default:
                return true;
            }
          };

          const fetchNannies = async () => {
            try {
              const userCollectionRef = collection(db, "USER");
              const q = query(userCollectionRef, where("role", "==", "nanny"));
              const userSnapshot = await getDocs(q);

              const nannyData = await Promise.all(
                userSnapshot.docs.map(async (userDoc) => {
                  const userData = userDoc.data();
                  const nannyDocRef = doc(db, "NANNY", userDoc.id);
                  const nannySnapshot = await getDoc(nannyDocRef);
                  const nannyDetails = nannySnapshot.data();
                  return { ...userData, ...nannyDetails, id: userDoc.id };
                })
              );

              nannies.value = nannyData;
              
              // Automatically select the first nanny if there are any nannies
              if (nannyData.length > 0) {
                selectedNanny.value = nannyData[0];
              }
              
              console.log("Fetched nannies:", nannyData);
            } catch (error) {
              console.error("Error fetching nanny data:", error);
            }
          };

          const sendMessage = async () => {
            if (!currentUserId.value || !selectedNanny.value) {
              alert("Please log in to send messages");
              return;
            }

            try {
              const chatData = {
                to_user_id: selectedNanny.value.id,
                from_user_id: currentUserId.value,
                timestamp: serverTimestamp(),
                message: `Hi, I would like to hire you and discuss details.`,
              };

              await addDoc(collection(db, "CHATS"), chatData);
              alert("Message sent successfully!");
            } catch (error) {
              console.error("Error sending message:", error);
              alert("Failed to send message. Please try again.");
            }
          };

          const filteredNannies = computed(() => {
            const query = searchQuery.value.toLowerCase();
            return nannies.value.filter((nanny) => {
              const matchesSearch =
                nanny.firstName?.toLowerCase().includes(query) ||
                nanny.lastName?.toLowerCase().includes(query);

              const matchesExperience = matchesExperienceFilter(
                nanny,
                experienceFilter.value
              );

              return matchesSearch && matchesExperience;
            });
          });

          const showDetails = (nanny) => {
            selectedNanny.value = nanny;
          };
          const searchJobs = () => {
            // If search results in no matches, clear selected nanny
            if (filteredNannies.value.length === 0) {
              selectedNanny.value = null;
            }
            // If current selection is filtered out, select the first visible nanny
            else if (!filteredNannies.value.includes(selectedNanny.value)) {
              selectedNanny.value = filteredNannies.value[0];
            }
          };

          onMounted(() => {
            document.addEventListener("click", handleClickOutside);
            auth.onAuthStateChanged((user) => {
              currentUserId.value = user ? user.uid : null;
            });
            fetchNannies();
          });

          onUnmounted(() => {
            document.removeEventListener("click", handleClickOutside);
          });

          return {
            nannies,
            selectedNanny,
            searchQuery,
            filteredNannies,
            showDetails,
            searchJobs,
            sendMessage,
            currentUserId,
            experienceFilter,
            showFilterMenu,
            experienceOptions,
            toggleFilterMenu,
            setExperienceFilter,
            clearExperienceFilter,
          };
        },
      }).mount("#app");
    </script>

    <script type="module">
      import { auth, db } from "./backend/firebase-config.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
      import {
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
      import { logout } from "./backend/auth.js";

      async function loadNavbar(user) {
        let fileToLoad = "unloggedin_navbar_template.html";

        if (user) {
          try {
            const userDoc = await getDoc(doc(db, "USER", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              if (userData.role === "parent") {
                fileToLoad = "parent_navbar_template.html";
              } else if (userData.role === "nanny") {
                fileToLoad = "nanny_navbar_template.html";
              }
            }
          } catch (error) {
            console.error("Error fetching user role:", error);
          }
        }

        try {
          const response = await fetch(fileToLoad);
          if (!response.ok) throw new Error("Network response was not ok");

          const navbarHTML = await response.text();
          document.getElementById("navbar").innerHTML = navbarHTML;

          // Add event listener to logout link after navbar is loaded
          const logoutLink = document.querySelector("#logoutBtn");
          if (logoutLink) {
            logoutLink.addEventListener("click", async (e) => {
              e.preventDefault(); // Prevent the default link behavior
              console.log("Logout clicked");
              try {
                await logout(); // The redirect is now handled in the logout function
              } catch (error) {
                console.error("Logout failed:", error);
              }
            });
          } else {
            console.log("Logout link not found");
          }
        } catch (error) {
          console.error("Failed to load navbar:", error);
        }
      }

      onAuthStateChanged(auth, (user) => {
        console.log("Auth state changed");
        loadNavbar(user);
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>